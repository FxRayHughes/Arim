name: Publish to TabooLib Repository

on:
  push:
    branches:
      - master

jobs:
  publish:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '#publish')

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Debug Secrets (å®‰å…¨æ˜¾ç¤º)
        run: |
          echo "ğŸ” æ£€æŸ¥ Secrets é…ç½®..."
          
          # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
          if [ -z "${{ secrets.NEXUS_MAPLEX_USERNAME }}" ]; then
            echo "âŒ é”™è¯¯ï¼šNEXUS_MAPLEX_USERNAME æœªè®¾ç½®ï¼"
            echo "è¯·åœ¨ GitHub ä»“åº“ Settings -> Secrets and variables -> Actions ä¸­æ·»åŠ "
            exit 1
          else
            USERNAME="${{ secrets.NEXUS_MAPLEX_USERNAME }}"
            echo "âœ… ç”¨æˆ·åå·²è®¾ç½®ï¼š${USERNAME:0:3}..."
          fi
          
          # æ£€æŸ¥å¯†ç æ˜¯å¦å­˜åœ¨
          if [ -z "${{ secrets.NEXUS_MAPLEX_PASSWORD }}" ]; then
            echo "âŒ é”™è¯¯ï¼šNEXUS_MAPLEX_PASSWORD æœªè®¾ç½®ï¼"
            echo "è¯·åœ¨ GitHub ä»“åº“ Settings -> Secrets and variables -> Actions ä¸­æ·»åŠ "
            exit 1
          else
            PASSWORD="${{ secrets.NEXUS_MAPLEX_PASSWORD }}"
            echo "âœ… å¯†ç å·²è®¾ç½®ï¼Œé•¿åº¦ï¼š${#PASSWORD}"
          fi

      - name: Test Nexus Connection
        run: |
          echo "ğŸ”Œ æµ‹è¯• Nexus è¿æ¥..."
          
          # ä½¿ç”¨ curl æµ‹è¯•è®¤è¯
          HTTP_CODE=$(curl -u "${{ secrets.NEXUS_MAPLEX_USERNAME }}:${{ secrets.NEXUS_MAPLEX_PASSWORD }}" \
                           -s -o /dev/null -w "%{http_code}" \
                           -I "https://nexus.maplex.top/service/metrics/ping")
          
          echo "HTTP å“åº”ç ï¼š$HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Nexus è®¤è¯æˆåŠŸï¼"
          else
            echo "âŒ Nexus è®¤è¯å¤±è´¥ï¼"
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "1. ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
            echo "2. è´¦æˆ·æ²¡æœ‰è¶³å¤Ÿçš„æƒé™"
            echo "3. Nexus æœåŠ¡å™¨é—®é¢˜"
          
            # æµ‹è¯•æœåŠ¡å™¨æ˜¯å¦å¯è¾¾
            echo ""
            echo "æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§..."
            if curl -s -o /dev/null -I "https://nexus.maplex.top"; then
              echo "âœ… æœåŠ¡å™¨å¯è¾¾"
            else
              echo "âŒ æœåŠ¡å™¨ä¸å¯è¾¾"
            fi
          
            exit 1
          fi

      - name: Build with Gradle
        run: |
          echo "ğŸ—ï¸ æ„å»ºé¡¹ç›®..."
          ./gradlew build --info

      - name: Publish to Nexus
        run: |
          echo "ğŸ“¦ å‘å¸ƒåˆ° Nexus..."
          ./gradlew publish \
            -PtaboolibUsername="${{ secrets.NEXUS_MAPLEX_USERNAME }}" \
            -PtaboolibPassword="${{ secrets.NEXUS_MAPLEX_PASSWORD }}" \
            --info
        env:
          GRADLE_OPTS: "-Xmx2g -Dfile.encoding=UTF-8"
