name: Publish to TabooLib Repository

on:
  push:
    branches:
      - master

jobs:
  publish:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '#publish')

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Test Nexus Connection
        run: |
          echo "ğŸ”Œ æµ‹è¯• Nexus è¿æ¥..."
          
          # ä½¿ç”¨ curl æµ‹è¯•è®¤è¯
          HTTP_CODE=$(curl -u "${{ secrets.NEXUS_MAPLEX_USERNAME }}:${{ secrets.NEXUS_MAPLEX_PASSWORD }}" \
                           -s -o /dev/null -w "%{http_code}" \
                           -I "https://nexus.maplex.top/service/metrics/ping")
          
          echo "HTTP å“åº”ç ï¼š$HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Nexus è®¤è¯æˆåŠŸï¼"
          else
            echo "âŒ Nexus è®¤è¯å¤±è´¥ï¼"
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "1. ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
            echo "2. è´¦æˆ·æ²¡æœ‰è¶³å¤Ÿçš„æƒé™"
            echo "3. Nexus æœåŠ¡å™¨é—®é¢˜"
          
            # æµ‹è¯•æœåŠ¡å™¨æ˜¯å¦å¯è¾¾
            echo ""
            echo "æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§..."
            if curl -s -o /dev/null -I "https://nexus.maplex.top"; then
              echo "âœ… æœåŠ¡å™¨å¯è¾¾"
            else
              echo "âŒ æœåŠ¡å™¨ä¸å¯è¾¾"
            fi
          
            exit 1
          fi

      - name: Build with Gradle
        run: |
          echo "ğŸ—ï¸ æ„å»ºé¡¹ç›®..."
          ./gradlew build --info

      - name: Publish to Nexus
        run: |
          echo "ğŸ“¦ å‘å¸ƒåˆ° Nexus..."
          ./gradlew publish \
            -PtaboolibUsername="${{ secrets.NEXUS_MAPLEX_USERNAME }}" \
            -PtaboolibPassword="${{ secrets.NEXUS_MAPLEX_PASSWORD }}" \
            --info
        env:
          GRADLE_OPTS: "-Xmx2g -Dfile.encoding=UTF-8"
